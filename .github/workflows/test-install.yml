name: Test install.sh after release

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

jobs:
  test-install:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      BIN_DIR: $HOME/.local/bin

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ§ª Run install.sh --dry-run
        run: |
          set -euo pipefail
          bash install.sh --dry-run

      - name: ðŸ§ª Install latest release
        run: |
          set -euo pipefail
          mkdir -p "$BIN_DIR"

          VERSION=$(gh release list --limit 1 --repo ${{ github.repository }} --json tagName --jq '.[0].tagName')
          echo "ðŸ‘‰ Installing version: $VERSION"

          VERSION="$VERSION" bash install.sh --prefix "$BIN_DIR" --force
        env:
          GH_TOKEN: ${{ github.token }}


      - name: âœ… Check version (direct path)
        run: ${{ env.BIN_DIR }}/context-for-ai --version

      - name: âœ… Check version from PATH
        run: context-for-ai --version
        env:
          PATH: ${{ env.BIN_DIR }}:$PATH

      - name: âœ… Check help from PATH
        run: context-for-ai --help
        env:
          PATH: ${{ env.BIN_DIR }}:$PATH
